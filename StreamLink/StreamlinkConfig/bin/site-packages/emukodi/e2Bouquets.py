#emukodi_path
#!/usr/bin/python
# -*- coding: utf-8 -*-
#
#   Coded by j00zek
#

import os
import re
import sys

from datetime import date
from emukodi.xbmcE2 import *
try:
    from channelsMappings import name2serviceDict, name2nameDict
except Exception:
    name2serviceDict = {}
    name2nameDict = {}

def generate_E2bouquet(file_name, frameWork, streamlinkURL, inputFile):
    print('Generuje bukiet %s ...' % file_name)
    bouquet_name = file_name.split('.')[1]
    channelsList = open(inputFile, 'r').readlines()

    name2emukodiDict = {}

    data = '#NAME %s aktualizacja %s\n' % (bouquet_name, date.today().strftime("%d-%m-%Y"))
    mainURL = 'https://player.pl/drm/'
    for item in channelsList:
        if '(brak-w-pakiecie)' in item: continue
        item = item.split('&')
        title=item[1].split('=')[1].strip()
        lcaseTitle = title.lower().replace('ś','s').replace('ń','n').replace(' ','')
        urlID=item[6].split('=')[1].strip()
        standardReference = '%s:0:1:0:0:0:0:0:0:0' % frameWork
        #mapowanie bezpośrednie zdefiniowane dla wp
        ServiceID = name2emukodiDict.get(title , standardReference)
        if ServiceID.startswith(standardReference):
            ServiceID = name2serviceDict.get(name2nameDict.get(lcaseTitle, lcaseTitle) , standardReference)
        #mapowanie po znalezionych kanalach w bukietach
        if ServiceID.startswith(standardReference):
            print("\t- Brak mapowania referencji kanału  %s (%s) dla EPG" % (title, lcaseTitle))
        data += '#SERVICE %s:%s%s%s:%s\n' % (ServiceID, streamlinkURL, mainURL.replace(':','%3a'),urlID , title)
        data += '#DESCRIPTION %s\n' % title

    with open(file_name, 'w') as f:
        f.write(data)
        f.close()
    
    print('Tworzenie bukietu zakończone')
    f = open('/etc/enigma2/bouquets.tv','r').read()
    if not os.path.basename(file_name) in f:
        print('Dodano bukiet do listy')
        if not f.endswith('\n'):
            f += '\n'
        f += '#SERVICE 1:7:1:0:0:0:0:0:0:0:FROM BOUQUET "%s" ORDER BY bouquet\n' % os.path.basename(file_name)
        open('/etc/enigma2/bouquets.tv','w').write(f)

if __name__ == '__main__':
    frameWork       = '5002'
    filename        = sys.argv[1]
    streamlinkURL   = 'http%3a//127.0.0.1%3a8088/'
    inputFile = os.path.join(working_dir,'xbmcplugin_addDirectoryItem')
    if os.path.exists(inputFile):
        generate_E2bouquet(filename, frameWork, streamlinkURL, inputFile)